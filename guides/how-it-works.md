# How typeroll Works

typeroll generates TypeScript declaration files by transforming `.d.ts` files into fake JavaScript that preserves type dependencies as real variables, enabling Bun's bundler to apply tree-shaking and name mangling.

## Core Process

```
TypeScript Source â†’ .d.ts Files â†’ Fake JavaScript â†’ Bundled JS â†’ Final .d.ts
       â”‚              â”‚              â”‚               â”‚             â”‚
       â”‚              â”‚              â”‚               â”‚             â”‚
       â–¼              â–¼              â–¼               â–¼             â–¼
   src/types.ts   Generated by    Type references   Tree-shaking   Clean, bundled
   src/utils.ts   Oxc Transform   as JS variables   + mangling     declaration
```

## The Token Magic

Type references become real JavaScript variables. This allows Bun's bundler to:
- Tree-shake unused types
- Rename types to avoid conflicts  
- Update all references consistently

## Example Transformation

### Input Files

```ts
// types.ts
export interface User {
    id: string;
    name: string;
}

export interface Admin {  // Never used anywhere
    id: string;
    permissions: string[];
}

// utils.ts  
import type { User } from './types';
export declare function greet(user: User): string;
```

### Step 1: Transform to Fake JavaScript

Each declaration becomes a variable with tokenized content:

```js
// From types.ts
export var User = ["interface ", User, " {\n    id: string;\n    name: string;\n}"];
export var Admin = ["interface ", Admin, " {\n    id: string;\n    permissions: string[];\n}"];

// From utils.ts
import { User } from './types';
export var greet = ["declare function ", greet, "(user: ", User, "): string;"];
```

Note: `User` appears as an actual variable reference, not a string `"User"`.

### Step 2: Bun Bundles the Fake JS

Bun treats this like real JavaScript:

```js
// Bundled output (tree-shaken + name mangled)
var User2 = ["interface ", User2, " {\n    id: string;\n    name: string;\n}"];
var greet2 = ["declare function ", greet2, "(user: ", User2, "): string;"];
export { greet2 as greet };

// Note: 
// - Admin was tree-shaken (unused)
// - User â†’ User2 (name mangling shown for demonstration)
// - All User references updated to User2
// - Name mangling occurs with large dependencies and conflicting exports
```

### Step 3: Convert Back to TypeScript

Tokens are stitched back together:

```ts
interface User2 {
    id: string;
    name: string;
}

declare function greet2(user: User2): string;

export { greet2 as greet };
```

## Benefits

- **âš¡ Speed**: Orders of magnitude faster than tsc-based approaches
- **ðŸŒ³ Tree-shaking**: Only used types appear in the output
- **ðŸ“¦ Single file**: Clean, self-contained declaration bundle
- **ðŸ’ª Robustness**: Handles complex type dependencies reliably
